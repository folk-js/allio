<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Browser Client</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background: #f0f0f0;
      }

      .status-indicator {
        position: fixed;
        top: 10px;
        right: 10px;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #ccc;
        transition: background-color 0.3s ease;
        z-index: 1000;
      }

      .status-indicator.connected {
        background: #4caf50;
      }

      .status-indicator.connecting {
        background: #ff9800;
      }

      .status-indicator.disconnected {
        background: #f44336;
      }

      .info-panel {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }

      .coordinate-info {
        font-family: monospace;
        background: #f5f5f5;
        padding: 10px;
        border-radius: 4px;
        margin: 10px 0;
      }

      h1 {
        color: #333;
        margin-bottom: 20px;
      }
    </style>
  </head>
  <body>
    <div
      class="status-indicator"
      id="statusDot"
      title="Connection Status"
    ></div>

    <h1>üåê Browser Client</h1>

    <div class="info-panel">
      <h3>Connection Status</h3>
      <p id="connectionStatus">Initializing...</p>

      <h3>Window Information</h3>
      <div class="coordinate-info" id="windowInfo">
        Detecting window position...
      </div>

      <h3>Manual Identification</h3>
      <button
        id="identifyButton"
        onclick="client.identifyWindow()"
        style="
          padding: 12px 24px;
          background: #4caf50;
          color: white;
          border: none;
          border-radius: 6px;
          font-size: 16px;
          cursor: pointer;
          margin: 10px 0;
        "
      >
        üéØ Identify This Window
      </button>

      <h3>Server Response</h3>
      <div id="serverResponse">
        Click the button above to identify this window...
      </div>

      <h3>Window ID</h3>
      <div
        id="windowId"
        style="font-family: monospace; font-weight: bold; color: #4caf50"
      >
        Not assigned yet
      </div>
    </div>

    <script type="module">
      import { InterlayClient } from "../src/interlay-client.js";

      class BrowserClient {
        constructor() {
          this.statusDot = document.getElementById("statusDot");
          this.connectionStatus = document.getElementById("connectionStatus");
          this.windowInfo = document.getElementById("windowInfo");
          this.serverResponse = document.getElementById("serverResponse");
          this.windowId = document.getElementById("windowId");

          this.wsClient = new InterlayClient();
          this.init();
        }

        async init() {
          // Get window coordinates first
          const coords = this.wsClient.getWindowCoordinates();
          this.updateWindowInfo(coords);

          // Set up event handlers
          this.wsClient.onConnectionChange = (status, message) => {
            this.updateStatus(status, message);
            if (status === "connected") {
              this.serverResponse.innerHTML =
                "Connected! Click 'Identify This Window' to match.";
            }
          };

          this.wsClient.onMessage = (data) => {
            this.handleServerMessage(data);
          };

          // Auto-connect to WebSocket
          await this.wsClient.connect();
        }

        // Manual identification triggered by button
        identifyWindow() {
          if (this.wsClient.isConnected()) {
            const coords = this.wsClient.getWindowCoordinates();
            console.log("üéØ Manual identification requested:", coords);
            this.wsClient.sendIdentification(coords);

            // Update display
            this.updateWindowInfo(coords);
            this.serverResponse.innerHTML = "<em>üîç Identifying window...</em>";
          } else {
            this.serverResponse.innerHTML =
              "<strong style='color: red'>‚ùå Not connected to overlay</strong>";
          }
        }

        updateWindowInfo(coords) {
          this.windowInfo.innerHTML = `
            Bottom-Left: (${coords.bottom_left_x}, ${coords.bottom_left_y})<br>
            Width: ${coords.window_width}px
          `;
        }

        updateStatus(status, message) {
          this.statusDot.className = `status-indicator ${status}`;
          this.connectionStatus.textContent = message;
        }

        handleServerMessage(data) {
          console.log("üì® Server response:", data);

          if (data.type === "identification_received") {
            // Show success or failure appropriately
            const statusIcon = data.success ? "‚úÖ" : "‚ùå";
            const statusColor = data.success ? "#4CAF50" : "#F44336";

            this.serverResponse.innerHTML = `
              <strong style="color: ${statusColor}">${statusIcon} ${data.message}</strong>
            `;

            // Update the window ID display
            if (data.window_id && data.success) {
              this.windowId.innerHTML = `
                <div>üéØ Window ID: ${data.window_id}</div>
              `;
              this.windowId.style.color = "#4CAF50";

              // Update page title to include the window ID
              document.title = `Browser Client [${data.window_id}]`;
            } else {
              this.windowId.textContent = "‚ùå Not matched";
              this.windowId.style.color = "#F44336";
              document.title = "Browser Client [unmatched]";
            }
          } else {
            // Handle window updates or other messages
            this.serverResponse.textContent = `Received: ${JSON.stringify(
              data
            )}`;
          }
        }

        // Update coordinates when window moves/resizes
        setupWindowTracking() {
          let updateTimeout;

          const updateCoords = () => {
            clearTimeout(updateTimeout);
            updateTimeout = setTimeout(() => {
              if (this.wsClient.isConnected()) {
                const coords = this.wsClient.getWindowCoordinates();
                this.wsClient.sendIdentification(coords);
              }
            }, 500); // Debounce updates
          };

          window.addEventListener("resize", updateCoords);
          window.addEventListener("move", updateCoords);

          // For browsers that don't support move event, poll occasionally
          setInterval(() => {
            const newCoords = this.wsClient.getWindowCoordinates();
            this.updateWindowInfo(newCoords);
          }, 5000);
        }
      }

      // Initialize when page loads
      let client;
      document.addEventListener("DOMContentLoaded", () => {
        client = new BrowserClient();
        client.setupWindowTracking();
      });
    </script>
  </body>
</html>
